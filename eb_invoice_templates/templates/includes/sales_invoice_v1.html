{% if letter_head and not no_letterhead %}
  <div class="letterhead">
    {{ letter_head }}
  </div>
{% endif %}
<style>
    {% include "eb_invoice_templates/templates/includes/_invoice.css" ignore missing %}
    {% include "eb_invoice_templates/templates/includes/print_a4.css" ignore missing %}
</style>

<div class="print-format">
    <h3 class="title">
        {{ _("Sales Invoice") }} {{ doc.name }}
    </h3>
    <div class="issuer" style="margin-top:10px;">
        <div>{{ _("Issue Date") }}:{{ doc.get_formatted("posting_date") }}</div>
        {% if doc.due_date %}
        <div>{{ _("Payment Due Date") }}:{{ doc.get_formatted("due_date") }}</div>
        {% endif %}
        {% if doc.tax_event_date %}
        <div>{{ _("Tax Event Date") }}:{{ doc.get_formatted("tax_event_date") }}</div>
        {% endif %}
    </div>

    {% set company = frappe.get_doc("Company", doc.company) %}
    <table class="parties-table" style="width:100%; border-collapse:collapse; margin:4mm 0 6mm;">
        <tr>
            <!-- Left column: issuer -->
            <td style="width:55%; vertical-align:top; padding:0 6mm 0 0; font-size:11px; line-height:1.35;">
            <div class="issuer-data">
                <strong style="font-size:12px;">{{ company.company_name or doc.company }}</strong><br>
                {% if doc.company_address_display %}
                {{ (doc.company_address_display | replace('<br><br>', '<br>')) | safe }}
                {% endif %}
                {% if company.tax_id %}
                <br>{{ _("VAT") }}: {{ company.tax_id }}
                {% endif %}
            </div>
            </td>

            <!-- Right column: client -->
            <td style="width:45%; vertical-align:top; padding:0; font-size:11px; line-height:1.35;">
            <div class="client-data">
                <div><strong>{{ _("Customer") }}:</strong> {{ doc.customer_name or doc.customer }}</div>
                {% set customer = doc.customer and frappe.get_cached_doc("Customer", doc.customer) %}
                {% if customer %}
                {% if customer.custom_eik %}<div>{{ _("EIK No.") }}: {{ customer.custom_eik }}</div>{% endif %}
                {% if customer.custom_vat_number %}<div>{{ _("VAT No.") }}: {{ customer.custom_vat_number }}</div>{% endif %}
                {% if customer.primary_address %}<div>{{ _("Address") }}: {{ customer.primary_address }}</div>{% endif %}
                {% if customer.materially_responsible_person %}<div>{{ _("MOL") }}: {{ customer.materially_responsible_person }}</div>{% endif %}
                {% if customer.emcs_tax_number %}<div>{{ _("EMCS Tax No") }}: {{ customer.emcs_tax_number }}</div>{% endif %}
                {% if customer.emcs_trader_number %}<div>{{ _("EMCS Trader No") }}: {{ customer.emcs_trader_number }}</div>{% endif %}
                {% endif %}
            </div>
            </td>
        </tr>
        </table>


    <div class="invoice">
        <table class="table table-bordered table-compact">
        <!-- New invoice items table -->
        <thead>
            <tr>
            <th style="width:6%">{{ _("No.") }}</th>
            <th style="width:44%">{{ _("Description") }}</th>
            <th class="num" style="width:16%">{{ _("Quantity Unit") }}</th>
            <th class="num" style="width:16%">{{ _("Unit Price") }}</th>
            <th class="num" style="width:18%">{{ _("Amount") }}</th>
            </tr>
        </thead>
        <tbody>
            {# accumulate totals + track UOMs #}
            {% set ns = namespace(total_qty=0, uoms=[]) %}
            {# sum of excise across rows (if you need it) #}
            {% set sum_excise = namespace(total=0.0) %}

            {% for row in doc.items %}
            {# load Item and (optionally) Batch #}
            {% set item = row.item_code and frappe.get_cached_doc("Item", row.item_code) %}
            {% set batch_doc = None %}
            {% if row.batch_no %}
                {% set batch_doc = frappe.get_cached_doc("Batch", row.batch_no) %}
            {% elif row.serial_and_batch_bundle %}
                {% set bundle = frappe.get_doc("Serial and Batch Bundle", row.serial_and_batch_bundle) %}
                {% for e in bundle.entries %}
                {% if e.batch_no and (not batch_doc) %}
                    {% set batch_doc = frappe.get_cached_doc("Batch", e.batch_no) %}
                {% endif %}
                {% endfor %}
            {% endif %}

            {# inputs for Excise calculation per row #}
            {% set rate_per_l = frappe.utils.flt((item and item.custom_excise_rate) or 0) %}
            {% set vol_l      = frappe.utils.flt((item and (item.custom_net_volume or item.custom_volume)) or 0) %}
            {% set liters_row = frappe.utils.flt(row.qty or 0) * vol_l %}
            {% set plato      = frappe.utils.flt((batch_doc and batch_doc.custom_plato) or (item and item.custom_plato) or 0) %}

            {# per-L and per-row excise #}
            {% set per_l      = plato * rate_per_l %}
            {% set excise_row = per_l * liters_row %}
            {% set sum_excise.total = sum_excise.total + excise_row %}

        <tr>
            <td class="num">{{ loop.index }}</td>

            {# DESCRIPTION CELL — your include must output a single <td>...</td> cell #}
            {% include "eb_invoice_templates/templates/includes/item_description.html" ignore missing %}

            <td class="num">{{ frappe.utils.flt(row.qty, 3) }} {{ row.uom or "" }}</td>
            <td class="num">{{ row.get_formatted("rate") }}</td>
            <td class="num">{{ row.get_formatted("amount") }}</td>
        </tr>

        {# Optional: an extra row right under each item showing excise details #}
        <tr>
            <td></td>
            <td colspan="4">
            <div class="micro" style="margin-top:4px;">
                <b>{{ _("Excise (this row)") }}:</b>
                {{ frappe.utils.fmt_money(excise_row, currency=None, precision=6) }} {{ doc.currency }}
                <span class="muted">
                ({{ frappe.utils.flt(liters_row, 3) }} L ×
                {{ frappe.utils.fmt_money(per_l, currency=None, precision=6) }} {{ doc.currency }}/L)
                </span>
            </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>


        <tfoot>
            {% set uom_label = ns.uoms[0] if ns.uoms|length == 1 else "" %}

            <tr>
            <td class="num" colspan="2"><strong>{{ _("Totals") }}</strong></td>
            <td class="num"><strong>{{ frappe.utils.flt(ns.total_qty, 3) }} {{ uom_label }}</strong></td>
            <td></td>
            <td class="num"><strong>{{ doc.get_formatted("total") }}</strong></td>
            </tr>
            <tr>
            <td colspan="4" class="text-right">{{ _("Taxes") }}</td>
            <td class="num">{{ doc.get_formatted("total_taxes_and_charges") }}</td>
            </tr>
            <tr class="grand">
            <td colspan="4" class="text-right"><strong>{{ _("Grand Total") }}</strong></td>
            <td class="num"><strong>{{ doc.get_formatted("grand_total") }}</strong></td>
            </tr>
            {% include "eb_invoice_templates/templates/includes/total_weight.html" ignore missing %}
            <tr>
            <td colspan="4" class="text-right"><b>{{ _("Total Excise") }}</b></td>
            <td class="num">
            <b>{{ frappe.utils.fmt_money(sum_excise.total, currency=doc.currency) }}</b>
            </td>
        </tr>
        </tfoot>
        </table>
         <td class="bank-cell">
                <div class="bank">
                    {{ eb_bank_block(doc) | safe }}
                </div>
            </td>
        <!-- New invoice items table END -->
        
        <table class="table totals pull-right">
            <tbody>
               
            </tbody>
        </table>

        {% if doc.terms %}
        <div class="terms">
            <strong>{{ _("Terms") }}:</strong> {{ doc.terms | striptags }}
        </div>
        {% endif %}
    </div>
</div>

