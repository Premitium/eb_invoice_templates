<div style="font-size:10px;color:#999;">TEMPLATE: EB v2</div>

<style>
    {
        % include "eb_invoice_templates/templates/includes/_invoice.css" ignore missing %
    }
</style>

<div class="print-format">

    {# --- Issuer (Company) details --- #}
    {% set company = frappe.get_doc("Company", doc.company) %}

    <div class="issuer-company" style="margin-top:8px;">
    <strong>{{ company.company_name or doc.company }}</strong><br>

        {# 1) Prefer the address captured on the invoice (fastest & safest) #}
        {% if doc.company_address_display %}
            {{ (doc.company_address_display or "") | replace("\n","<br>") | safe }}
        {% else %}
        {# 2) Fallback: first Address linked to this Company #}
        {% set links = frappe.get_all(
            "Dynamic Link",
            filters={"parenttype":"Address","link_doctype":"Company","link_name":doc.company},
            fields=["parent"],
            limit=1
        ) %}
        {% if links %}
        {% set comp_addr = frappe.get_doc("Address", links[0].parent) %}
        {{ comp_addr.address_line1 or "" }}{% if comp_addr.address_line2 %}<br>{{ comp_addr.address_line2 }}{% endif %}
        {% if comp_addr.pincode or comp_addr.city %}<br>
            {{ comp_addr.pincode or "" }} {{ comp_addr.city or "" }}
        {% endif %}
        {% if comp_addr.country %}<br>{{ comp_addr.country }}{% endif %}
        {% if comp_addr.phone %}<br>{{ _("Phone") }}: {{ comp_addr.phone }}{% endif %}
        {% if comp_addr.email_id %}<br>{{ comp_addr.email_id }}{% endif %}
        {% endif %}
        {% endif %}

        {# Optional extras printed if present on Company #}
        {% if company.tax_id %}<br>{{ _("VAT") }}: {{ company.tax_id }}{% endif %}
    </div>


    <div class="invoice">
        <h3>{{ _("Sales Invoice") }} {{ doc.name }}</h3>
        <div>{{ _("Issue Date") }}: {{ doc.get_formatted("posting_date") }}</div>
        <div>{{ _("Payment Due Date") }}: {{ doc.get_formatted("due_date") }}</div>
        <div>{{ _("Tax Event Date Date") }}: {{ doc.get_formatted("tax_event_date") }}</div>

       {# --- collect company bank accounts --- #}
        {% set bank_accounts = frappe.get_all(
            "Bank Account",
            filters={"company": doc.company, "is_company_account": 1},
            fields=["name","is_default","bank","account_name",
                    "bank_account_no","iban"]
        ) %}

        {# account selected on the invoice (if any) #}
        {% set selected_ba = doc.company_bank_account or doc.bank_account %}

        {% if bank_accounts %}
        <div style="margin-top:10px;">
            <strong>{{ _("Company Bank Accounts") }}</strong>
            <ul style="margin:6px 0 0 16px;">
            {% for ba in bank_accounts %}
                {% set banknm = ba.bank or ba.bank_name %}
                {% set bank_doc = ba.bank and frappe.get_cached_doc("Bank", ba.bank) %}
                {% set swift = bank_doc and bank_doc.swift %}
                <li style="margin-bottom:6px;">
                {% if selected_ba == ba.name %}<b>[{{ _("Selected") }}]</b> {% elif ba.is_default %}<b>[{{ _("Default") }}]</b> {% endif %}
                <b>{{ holder or doc.company }}</b>
                {% if banknm %} — {{ banknm }}{% endif %}
                {% if ba.iban %} — IBAN: {{ ba.iban }}{% endif %}
                {% if swift %} — SWIFT/BIC: {{ swift }}{% endif %}
                {% if ba.bank_address %}
                    <br><span class="muted">{{ ba.bank_address | replace("\n","<br>") | safe }}</span>
                {% endif %}
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}


        <!-- {# Resolve the bank account name #}
        {% set ba_name = doc.company_bank_account or doc.bank_account %}  {# if chosen on the invoice #}
        {% if not ba_name and doc.debit_to %}
        {% set acc = frappe.get_cached_doc("Account", doc.debit_to) %}
        {% set ba_name = acc.default_bank_account %}
        {% endif %}

        {# Render basic label or full details #}
        {% if ba_name %}
        {% set ba = frappe.get_cached_doc("Bank Account", ba_name) %}
        <div>
            {{ _("Bank Account") }}:
            {{ ba.account_name or ba.account_holder_name or ba_name }}
            {% if ba.iban %} — IBAN: {{ ba.iban }}{% endif %}
            {% if ba.account_no %} — {{ _("Account No.") }}: {{ ba.account_no }}{% endif %}
            {% if ba.swift_number or ba.swift_code %} — SWIFT/BIC: {{ ba.swift_number or ba.swift_code }}{% endif %}
        </div>
        {% endif %} -->

        <div class="meta grid-3">
            <div>{{ _("Customer") }}: {{ doc.customer_name or doc.customer }}</div>
            {% set customer = doc.customer and frappe.get_cached_doc("Customer", doc.customer) %}
            <div>
                {{ _("EIK No.") }}: {{ customer.custom_eik }}
            </div>
            <div>
                {{ _("VAT No.") }}: {{ customer.custom_vat_number }}
            </div>
            <div>
                {{ _("Address") }}: {{ customer.primary_address }}
            </div>
            <div>
                {{ _("MOL") }}: {{ customer.materially_responsible_person }}
            </div>
            <div>
                {{ _("EMCS Tax No") }}: {{ customer.emcs_tax_number }}
            </div>
            <div>
               {{ _("EMCS Trader No") }}: {{ customer.emcs_trader_number }}
            </div>
        </div>
        
        <table class="table table-bordered table-compact items">
            <thead>
                <tr>
                    <th>{{ _("Item") }}</th>
                    <th class="num">{{ _("Qty") }}</th>
                    <th class="num">{{ _("Rate") }}</th>
                    <th class="num">{{ _("Amount") }}</th>
                </tr>
            </thead>
            <tbody>

                {% for row in doc.items %}
                {% set item = frappe.get_cached_doc("Item", row.item_code) if row.item_code else None %}
                {% if item %}
                <!-- Weight per Item Start -->
                <tr>
                    <td style="width:40%">{{ _("Gross Weight (per unit)") }}</td>
                    <td>{{ frappe.utils.flt(item.weight_per_unit, 3) }} {{ wuom or "" }}</td>
                </tr>
                <!-- Weight per Item End -->
                {% endif %}
                <!-- {% include "eb_invoice_templates/templates/includes/debug.html" ignore missing %} -->
                <tr>
                    <td>
                        <div class="item-name">{{ row.item_name or row.item_code }}</div>
                        {% if row.description %}
                        <div class="desc">{{ row.description | striptags }}</div>
                        {% endif %}

                        {# --- Batches (Serial and Batch Bundle preferred) --- #}
                        {% if row.serial_and_batch_bundle %}
                        {% set bundle = frappe.get_doc("Serial and Batch Bundle", row.serial_and_batch_bundle) %}
                        <table class="table table-bordered table-compact" style="margin-top:6px;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">{{ _("Batch No") }}</th>
                                    <th style="text-align:right;">{{ _("Batch Qty") }}</th>
                                    <th style="text-align:left;">{{ _("Expiry") }}</th>
                                    <th>{{ _("Plato") }}<br><span class="muted">custom_plato</span></th>
                                </tr>
                            </thead>
                           
                        </table>

                        {% elif row.batch_no %}
                        {# define batch_doc here! #}
                        {% set batch_doc = frappe.get_cached_doc("Batch", row.batch_no) %}
                        
                        {# inputs #}
                        {% set plato = frappe.utils.flt(batch_doc.custom_plato) %}
                        {% set rate_per_l = frappe.utils.flt((item and item.custom_excise_rate) or 0) %}
                        {% set vol_l = frappe.utils.flt((item and item.custom_volume) or 0) %}
                        {% set liters_row = frappe.utils.flt(row.qty or 0) * vol_l %}

                        {# per-L excise is plato × per-L rate (no hL conversion) #}
                        {% set per_l = plato * rate_per_l %}
                        {% set excise_row = per_l * liters_row %}

                        <table class="table table-bordered table-compact" style="margin-top:6px;">
                            <thead>
                            <tr>
                                <th style="text-align:left;">{{ _("Batch No") }}</th>
                                <th style="text-align:right;">{{ _("Batch Qty") }}</th>
                                <th style="text-align:left;">{{ _("Expiry") }}</th>
                                <th>{{ _("Plato") }}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>{{ row.batch_no }}</td>
                                <td class="num">{{ row.qty or 0 }}</td>
                                <td>{{ batch_doc.expiry_date or "" }}</td>
                                <td>{{ batch_doc.custom_plato or "" }}</td>
                            </tr>
                            </tbody>
                        </table>

                        <div class="micro" style="margin-top:4px;">
                            <b>{{ _("Excise (this row)") }}:</b>
                            {{ frappe.utils.fmt_money(excise_row, currency=None, precision=6) }} {{ doc.currency }}
                            <span class="muted">
                            ({{ frappe.utils.flt(liters_row, 3) }} L ×
                            {{ frappe.utils.fmt_money(per_l, currency=None, precision=6) }} {{ doc.currency }}/L)
                            </span>
                        </div>
                        {% endif %}

                        {# --- per-item micro details (keep your exact properties) --- #}
                        <div class="micro" style="margin-top:6px;">
                            <table class="table table-bordered table-compact">
                                <tbody>
                                    <tr>
                                        <td style="width:40%">{{ _("Tariff") }}</td>
                                        <td>{{ (item and item.custom_tariff) or "" }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width:40%">{{ _("Excise Rate") }}</td>
                                        <td>
                                            {% if item and item.custom_excise_rate %}
                                            {{ item.custom_excise_rate }} {{ doc.currency }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="width:40%">{{ _("Volume") }}</td>
                                        <td>{{ (item and item.custom_volume) or "" }}</td>
                                    </tr>

                                    <tr>
                                        <td style="width:40%">{{ _("Country of Origin") }}</td>
                                        <td>{{ (item and item.country_of_origin) or "" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </td>

                    <td class="num">{{ row.qty }}</td>
                    <td class="num">{{ row.get_formatted("rate") }}</td>
                    <td class="num">{{ row.get_formatted("amount") }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <table class="table totals pull-right">
            <tbody>
                <tr>
                    <td class="label">{{ _("Net Total") }}</td>
                    <td class="value">{{ doc.get_formatted("total") }}</td>
                </tr>
                <tr>
                    <td class="label">{{ _("Taxes") }}</td>
                    <td class="value">{{ doc.get_formatted("total_taxes_and_charges") }}</td>
                </tr>
                <tr class="grand">
                    <td class="label"><strong>{{ _("Grand Total") }}</strong></td>
                    <td class="value"><strong>{{ doc.get_formatted("grand_total") }}</strong></td>
                </tr>
                {% if doc.rounded_total %}
                <tr>
                    <td class="label">{{ _("Rounded Total") }}</td>
                    <td class="value">{{ doc.get_formatted("rounded_total") }}</td>
                </tr>
                {% endif %}
                {% include "eb_invoice_templates/templates/includes/total_weight.html" ignore missing %}
                {% include "eb_invoice_templates/templates/includes/sales_invoice_properties.html" ignore missing %}
            </tbody>
        </table>

        {% if doc.terms %}
        <div class="terms">
            <strong>{{ _("Terms") }}:</strong> {{ doc.terms | striptags }}
        </div>
        {% endif %}
    </div>
</div>

{% set total_w = (doc.items | map(attribute='custom_total_weight_kg_at_20c') | select | sum) %}
<tr>
  <td class="label">{{ _("Total Weight @20°C") }}</td>
  <td class="value">{{ frappe.utils.flt(total_w, 3) }} {{ _("kg") }}</td>
</tr>
{% set total_w1 = (doc.items | map(attribute='custom_weight_kg_at_20c') | select | sum) %}
<tr>
  <td class="label">{{ _("Item Weight @20°C") }}</td>
  <td class="value">{{ frappe.utils.flt(total_w1, 3) }} {{ _("kg") }}</td>
</tr>

