<div style="font-size:10px;color:#999;">TEMPLATE: EB v2</div>

<style>
    {% include "eb_invoice_templates/templates/includes/_invoice.css" ignore missing %}
    {% include "eb_invoice_templates/templates/includes/print_a4.css" ignore missing %}
</style>

<div class="print-format">
    {# --- Issuer (Company) details --- #}
    {% set company = frappe.get_doc("Company", doc.company) %}

    <div class="issuer-company" style="margin-top:8px;">
    <strong>{{ company.company_name or doc.company }}</strong><br>

        {# 1) Prefer the address captured on the invoice (fastest & safest) #}
        {% if doc.company_address_display %}
            {{ (doc.company_address_display or "") | replace("\n","<br>") | safe }}
        {% else %}
        {# 2) Fallback: first Address linked to this Company #}
        {% set links = frappe.get_all(
            "Dynamic Link",
            filters={"parenttype":"Address","link_doctype":"Company","link_name":doc.company},
            fields=["parent"],
            limit=1
        ) %}
        {% if links %}
        {% set comp_addr = frappe.get_doc("Address", links[0].parent) %}
        {{ comp_addr.address_line1 or "" }}{% if comp_addr.address_line2 %}<br>{{ comp_addr.address_line2 }}{% endif %}
        {% if comp_addr.pincode or comp_addr.city %}<br>
            {{ comp_addr.pincode or "" }} {{ comp_addr.city or "" }}
        {% endif %}
        {% if comp_addr.country %}<br>{{ comp_addr.country }}{% endif %}
        {% if comp_addr.phone %}<br>{{ _("Phone") }}: {{ comp_addr.phone }}{% endif %}
        {% if comp_addr.email_id %}<br>{{ comp_addr.email_id }}{% endif %}
        {% endif %}
        {% endif %}

        {# Optional extras printed if present on Company #}
        {% if company.tax_id %}<br>{{ _("VAT") }}: {{ company.tax_id }}{% endif %}
    </div>


    <div class="invoice">
        <h3>{{ _("Sales Invoice") }} {{ doc.name }}</h3>
        <div>{{ _("Issue Date") }}: {{ doc.get_formatted("posting_date") }}</div>
        <div>{{ _("Payment Due Date") }}: {{ doc.get_formatted("due_date") }}</div>
        <div>{{ _("Tax Event Date Date") }}: {{ doc.get_formatted("tax_event_date") }}</div>
        
        <!-- BANK Details -->
        {{ eb_bank_block(doc) | safe }}
         <!-- BANK Details -->
        <div class="meta grid-3">
            <div>{{ _("Customer") }}: {{ doc.customer_name or doc.customer }}</div>
            {% set customer = doc.customer and frappe.get_cached_doc("Customer", doc.customer) %}
            <div>
                {{ _("EIK No.") }}: {{ customer.custom_eik }}
            </div>
            <div>
                {{ _("VAT No.") }}: {{ customer.custom_vat_number }}
            </div>
            <div>
                {{ _("Address") }}: {{ customer.primary_address }}
            </div>
            <div>
                {{ _("MOL") }}: {{ customer.materially_responsible_person }}
            </div>
            <div>
                {{ _("EMCS Tax No") }}: {{ customer.emcs_tax_number }}
            </div>
            <div>
               {{ _("EMCS Trader No") }}: {{ customer.emcs_trader_number }}
            </div>
        </div>

        <table class="table table-bordered table-compact">
        <!-- New invoice items table -->
        <thead>
            <tr>
            <th style="width:6%">{{ _("No.") }}</th>
            <th style="width:44%">{{ _("Description") }}</th>
            <th class="num" style="width:16%">{{ _("Quantity Unit") }}</th>
            <th class="num" style="width:16%">{{ _("Unit Price") }}</th>
            <th class="num" style="width:18%">{{ _("Amount") }}</th>
            </tr>
        </thead>
        <tbody>
            {# accumulate totals + track UOMs #}
            {% set ns = namespace(total_qty=0, uoms=[]) %}

            {% for row in doc.items %}
            <tr>
            <td class="num">{{ loop.index }}</td>
            
            {% include "eb_invoice_templates/templates/includes/item_description.html" ignore missing %}
            
            <td class="num">{{ frappe.utils.flt(row.qty, 3) }} {{ row.uom or "" }}</td>
            <td class="num">{{ row.get_formatted("rate") }}</td>
            <td class="num">{{ row.get_formatted("amount") }}</td>
            </tr>

            {# update totals #}
            {% set ns.total_qty = ns.total_qty + (row.qty or 0) %}
            {% if row.uom and (row.uom not in ns.uoms) %}
            {% set ns.uoms = ns.uoms + [row.uom] %}
            {% endif %}
            {% endfor %}
        </tbody>

        <tfoot>
            {% set uom_label = ns.uoms[0] if ns.uoms|length == 1 else "" %}

            <tr>
            <td class="num" colspan="2"><strong>{{ _("Totals") }}</strong></td>
            <td class="num"><strong>{{ frappe.utils.flt(ns.total_qty, 3) }} {{ uom_label }}</strong></td>
            <td></td>
            <td class="num"><strong>{{ doc.get_formatted("total") }}</strong></td>
            </tr>
            <tr>
            <td colspan="4" class="text-right">{{ _("Taxes") }}</td>
            <td class="num">{{ doc.get_formatted("total_taxes_and_charges") }}</td>
            </tr>
            <tr class="grand">
            <td colspan="4" class="text-right"><strong>{{ _("Grand Total") }}</strong></td>
            <td class="num"><strong>{{ doc.get_formatted("grand_total") }}</strong></td>
            </tr>
            {% if doc.rounded_total %}
            <tr>
            <td colspan="4" class="text-right">{{ _("Rounded Total") }}</td>
            <td class="num">{{ doc.get_formatted("rounded_total") }}</td>
            </tr>
            {% endif %}
            {% include "eb_invoice_templates/templates/includes/total_weight.html" ignore missing %}
        </tfoot>
        </table>
        <!-- New invoice items table END -->
        
        <table class="table totals pull-right">
            <tbody>
               
            </tbody>
        </table>

        {% if doc.terms %}
        <div class="terms">
            <strong>{{ _("Terms") }}:</strong> {{ doc.terms | striptags }}
        </div>
        {% endif %}
    </div>
</div>

