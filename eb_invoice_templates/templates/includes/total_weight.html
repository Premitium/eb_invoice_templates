{# --- Total Weight across all rows --- #}
{% set ns = namespace(total=0.0, uom="") %}
{% for r in doc.items %}
  {# 1) pick per-unit weight and UOM: row -> item fallback #}
  {% set wpu = r.weight_per_unit %}
  {% set wuom = r.weight_uom %}
  {% if (wpu is none) or (wpu == 0) %}
    {% set it = r.item_code and frappe.get_cached_doc("Item", r.item_code) %}
    {% set wpu = wpu if wpu not in (None, 0) else (it and it.weight_per_unit) %}
    {% set wuom = wuom or (it and it.weight_uom) %}
  {% endif %}

  {# 2) row total weight: use row.total_weight if present, else qty * wpu #}
  {% if r.total_weight not in (None, 0) %}
    {% set row_wt = frappe.utils.flt(r.total_weight) %}
  {% else %}
    {% set row_wt = frappe.utils.flt(r.qty or 0) * frappe.utils.flt(wpu or 0) %}
  {% endif %}

  {% set ns.total = ns.total + row_wt %}
  {% if not ns.uom and wuom %}{% set ns.uom = wuom %}{% endif %}
{% endfor %}

<tr>
  <td class="label">{{ _("Total Gross Weight") }}</td>
  <td class="value">{{ frappe.utils.flt(ns.total, 3) }} {{ ns.uom }}</td>
</tr>